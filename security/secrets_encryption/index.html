
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.rke2.io/security/secrets_encryption/">
      
      <link rel="icon" href="../../assets/favicon-32x32.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.3">
    
    
      
        <title>Secrets Encryption - RKE2 - Rancher's Next Generation Kubernetes Distribution</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7a952b86.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Work+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Work Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#secrets-encryption-config" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="RKE2 - Rancher&#39;s Next Generation Kubernetes Distribution" class="md-header__button md-logo" aria-label="RKE2 - Rancher's Next Generation Kubernetes Distribution" data-md-component="logo">
      
  <img src="../../assets/logo-stacked-white-rke2.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            RKE2 - Rancher's Next Generation Kubernetes Distribution
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Secrets Encryption
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/rancher/rke2" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="RKE2 - Rancher&#39;s Next Generation Kubernetes Distribution" class="md-nav__button md-logo" aria-label="RKE2 - Rancher's Next Generation Kubernetes Distribution" data-md-component="logo">
      
  <img src="../../assets/logo-stacked-white-rke2.svg" alt="logo">

    </a>
    RKE2 - Rancher's Next Generation Kubernetes Distribution
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/rancher/rke2" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Installation" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/requirements/" class="md-nav__link">
        Requirements
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/quickstart/" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/ha/" class="md-nav__link">
        High Availability
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4">
          Install Options
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Install Options" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Install Options
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/install_options/install_options/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/install_options/server_config/" class="md-nav__link">
        Server Configuration Reference
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/install_options/linux_agent_config/" class="md-nav__link">
        Agent Configuration Reference
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/install_options/windows_agent_config/" class="md-nav__link">
        Windows Agent Configuration Reference
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/methods/" class="md-nav__link">
        Installation Methods
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/network_options/" class="md-nav__link">
        Network Options
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/containerd_registry_configuration/" class="md-nav__link">
        Containerd Registry Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/airgap/" class="md-nav__link">
        Air-Gap Install
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/windows_airgap/" class="md-nav__link">
        Windows Air-Gap Install
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/linux_uninstall/" class="md-nav__link">
        Linux Uninstall
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../install/windows_uninstall/" class="md-nav__link">
        Windows Uninstall
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Upgrades
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Upgrades" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Upgrades
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../upgrade/upgrade/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../upgrade/basic_upgrade/" class="md-nav__link">
        Upgrade Basics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../upgrade/automated_upgrade/" class="md-nav__link">
        Automated Upgrades
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../about_hardened_images/" class="md-nav__link">
        About Hardened Images
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hardening_guide/" class="md-nav__link">
        CIS Hardening Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cis_self_assessment16/" class="md-nav__link">
        CIS v1.6 Self-Assessment Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../fips_support/" class="md-nav__link">
        FIPS 140-2 Enablement
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../policies/" class="md-nav__link">
        Default Policy Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../selinux/" class="md-nav__link">
        SELinux
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Secrets Encryption
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Secrets Encryption
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#secrets-encryption-config" class="md-nav__link">
    Secrets Encryption Config
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secrets-encryption-tool" class="md-nav__link">
    Secrets Encryption Tool
  </a>
  
    <nav class="md-nav" aria-label="Secrets Encryption Tool">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-server-encryption-key-rotation" class="md-nav__link">
    Single-Server Encryption Key Rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-server-encryption-key-rotation" class="md-nav__link">
    Multi-Server Encryption Key Rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secrets-encryption-status" class="md-nav__link">
    Secrets Encryption Status
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Architecture
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Architecture" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/architecture/" class="md-nav__link">
        Anatomy of a Next Generation Kubernetes Distribution
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../cluster_access/" class="md-nav__link">
        Cluster Access
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../backup_restore/" class="md-nav__link">
        Etcd Backup and Restore
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../networking/" class="md-nav__link">
        Networking
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../helm/" class="md-nav__link">
        Helm Integration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/" class="md-nav__link">
        Advanced Options and Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../subcommands/" class="md-nav__link">
        Subcommands
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../known_issues/" class="md-nav__link">
        Known Issues and Limitations
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#secrets-encryption-config" class="md-nav__link">
    Secrets Encryption Config
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secrets-encryption-tool" class="md-nav__link">
    Secrets Encryption Tool
  </a>
  
    <nav class="md-nav" aria-label="Secrets Encryption Tool">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-server-encryption-key-rotation" class="md-nav__link">
    Single-Server Encryption Key Rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-server-encryption-key-rotation" class="md-nav__link">
    Multi-Server Encryption Key Rotation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secrets-encryption-status" class="md-nav__link">
    Secrets Encryption Status
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/rancher/rke2/edit/master/docs/security/secrets_encryption.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


  <h1>Secrets Encryption</h1>

<h2 id="secrets-encryption-config">Secrets Encryption Config<a class="headerlink" href="#secrets-encryption-config" title="Permanent link">&para;</a></h2>
<p>RKE2 supports encrypting Secrets at rest, and will do the following automatically:</p>
<ul>
<li>Generate an AES-CBC key</li>
<li>Generate an encryption config file with the generated key:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">{</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;kind&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;EncryptionConfiguration&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;apiVersion&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;apiserver.config.k8s.io/v1&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;resources&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">{</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;resources&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;secrets&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">],</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;providers&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">{</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;aescbc&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;keys&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"></span>
<span class="w">              </span><span class="p p-Indicator">{</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;name&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;aescbckey&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;secret&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;xxxxxxxxxxxxxxxxxxx&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p p-Indicator">}</span><span class="w"></span>
<span class="w">            </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">}</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">},</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">{</span><span class="w"></span>
<span class="w">          </span><span class="s">&quot;identity&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">}</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">}</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="p p-Indicator">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>Pass the config to the Kubernetes APIServer as encryption-provider-config</li>
</ul>
<p>Once enabled any created secret will be encrypted with this key. Note that if you disable encryption then any encrypted secrets will not be readable until you enable encryption again using the same key.</p>
<h2 id="secrets-encryption-tool">Secrets Encryption Tool<a class="headerlink" href="#secrets-encryption-tool" title="Permanent link">&para;</a></h2>
<p><em>Available as of v1.21.8+rke2r1</em></p>
<p>RKE2 contains a utility <a href="https://docs.rke2.io/subcommands/#secrets-encrypt">subcommand</a> <code>secrets-encrypt</code>, which allows administrators to perform the following tasks:</p>
<ul>
<li>Adding new encryption keys</li>
<li>Rotating and deleting encryption keys</li>
<li>Reencrypting secrets</li>
</ul>
<blockquote>
<p><strong>Warning:</strong> Failure to follow proper procedure when rotating secrets encryption keys can cause permanent data loss. Proceed with caution.</p>
</blockquote>
<h3 id="single-server-encryption-key-rotation">Single-Server Encryption Key Rotation<a class="headerlink" href="#single-server-encryption-key-rotation" title="Permanent link">&para;</a></h3>
<p>To rotate secrets encryption keys on a single-node cluster:</p>
<ol>
<li>
<p>Prepare:</p>
<div class="highlight"><pre><span></span><code>rke2 secrets-encrypt prepare
</code></pre></div>
</li>
<li>
<p>Restart the <code>kube-apiserver</code> pod:</p>
<div class="highlight"><pre><span></span><code># Get the kube-apiserver container ID
export CONTAINER_RUNTIME_ENDPOINT=&quot;unix:///var/run/k3s/containerd/containerd.sock&quot;
crictl ps --name kube-apiserver
# Stop the pod
crictl stop &lt;CONTAINER_ID&gt;
</code></pre></div>
</li>
<li>
<p>Rotate:</p>
<div class="highlight"><pre><span></span><code>rke2 secrets-encrypt rotate
</code></pre></div>
</li>
<li>
<p>Restart the <code>kube-apiserver</code> pod again</p>
</li>
<li>
<p>Reencrypt:</p>
<div class="highlight"><pre><span></span><code>rke2 secrets-encrypt reencrypt
</code></pre></div>
</li>
</ol>
<h3 id="multi-server-encryption-key-rotation">Multi-Server Encryption Key Rotation<a class="headerlink" href="#multi-server-encryption-key-rotation" title="Permanent link">&para;</a></h3>
<p>To rotate secrets encryption keys on HA setups:</p>
<blockquote>
<p><strong>Note:</strong> In this example, 3 servers are used to for a HA cluster, referred to as S1, S2, S3. While not required, it is recommended that you pick one server node from which to run the <code>secrets-encrypt</code> commands.</p>
</blockquote>
<ol>
<li>
<p>Prepare on S1</p>
<div class="highlight"><pre><span></span><code>rke2 secrets-encrypt prepare
</code></pre></div>
</li>
<li>
<p>Sequentially Restart S1, S2, S3
    <div class="highlight"><pre><span></span><code>systemctl restart rke2-server.service
</code></pre></div>
    Wait for the systemctl command to return before restarting the next server.</p>
</li>
<li>
<p>Rotate on S1</p>
<div class="highlight"><pre><span></span><code>rke2 secrets-encrypt rotate
</code></pre></div>
</li>
<li>
<p>Sequentially Restart S1, S2, S3</p>
</li>
<li>
<p>Reencrypt on S1</p>
<p><div class="highlight"><pre><span></span><code>rke2 secrets-encrypt reencrypt
</code></pre></div>
Wait until reencryption is finished, either via server logs <code>journalctl -u rke2-server</code> or via <code>rke2 secrets-encrypt status</code>. The status will return <code>reencrypt_finished</code> when done.</p>
</li>
<li>
<p>Sequentially Restart S1, S2, S3</p>
</li>
</ol>
<h3 id="secrets-encryption-status">Secrets Encryption Status<a class="headerlink" href="#secrets-encryption-status" title="Permanent link">&para;</a></h3>
<p>The <code>secrets-encrypt status</code> subcommand displays information about the current status of secrets encryption on the node.</p>
<p>An example of the command on a single-server node:<br />
<div class="highlight"><pre><span></span><code>$ rke2 secrets-encrypt status
Encryption Status: Enabled
Current Rotation Stage: start
Server Encryption Hashes: All hashes match

Active  Key Type  Name
------  --------  ----
 *      AES-CBC   aescbckey
</code></pre></div></p>
<p>Another example on HA cluster, after rotating the keys, but before restarting the servers:<br />
<div class="highlight"><pre><span></span><code>$ rke2 secrets-encrypt status
Encryption Status: Enabled
Current Rotation Stage: rotate
Server Encryption Hashes: hash does not match between node-1 and node-2

Active  Key Type  Name
------  --------  ----
 *      AES-CBC   aescbckey-2021-12-10T22:54:38Z
        AES-CBC   aescbckey
</code></pre></div></p>
<p>Details on each section are as follows:  </p>
<ul>
<li><strong>Encryption Status</strong>: Displayed whether secrets encryption is disabled or enabled on the node  </li>
<li><strong>Current Rotation Stage</strong>: Indicates the current rotation stage on the node.<br />
  Stages are: <code>start</code>, <code>prepare</code>, <code>rotate</code>, <code>reencrypt_request</code>, <code>reencrypt_active</code>, <code>reencrypt_finished</code>  </li>
<li><strong>Server Encryption Hashes</strong>: Useful for HA clusters, this indicates whether all servers are on the same stage with their local files. This can be used to identify whether a restart of servers is required before proceeding to the next stage. In the HA example above, node-1 and node-2 have different hashes, indicating that they currently do not have the same encryption configuration. Restarting the servers will sync up their configuration.</li>
<li><strong>Key Table</strong>: Summarizes information about the secrets encryption keys found on the node.  </li>
<li><strong>Active</strong>: The "*" indicates which, if any, of the keys are currently used for secrets encryption. An active key is used by Kubernetes to encrypt any new secrets.</li>
<li><strong>Key Type</strong>: RKE2 only supports the <code>AES-CBC</code> key type. Find more info <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/#providers">here.</a></li>
<li><strong>Name</strong>: Name of the encryption key.  </li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../selinux/" class="md-footer__link md-footer__link--prev" aria-label="Previous: SELinux" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              SELinux
            </div>
          </div>
        </a>
      
      
        
        <a href="../../architecture/architecture/" class="md-footer__link md-footer__link--next" aria-label="Next: Anatomy of a Next Generation Kubernetes Distribution" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Anatomy of a Next Generation Kubernetes Distribution
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.37e9125f.min.js"></script>
      
    
  </body>
</html>